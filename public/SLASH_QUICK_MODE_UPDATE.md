# 快速标注模式下的斜杠插入/删除功能更新

## 📋 更新内容

用户要求："快速标注模式斜杠能多次插入并能删除斜杠"

### 核心改进
1. **快速模式下连续插入**：在快速标注模式下，插入斜杠后不自动关闭插入模式，支持连续多次插入
2. **删除斜杠功能**：点击已插入的斜杠字符可以删除它
3. **智能模式切换**：根据是否在快速标注模式下，自动调整行为和提示信息

---

## 🔍 功能对比

### 普通模式 vs 快速标注模式

| 特性 | 普通模式 | 快速标注模式 |
|------|---------|-------------|
| **插入斜杠** | 点击位置插入，插入后自动关闭 | 点击位置插入，**保持模式开启** |
| **删除斜杠** | 点击斜杠删除，删除后自动关闭 | 点击斜杠删除，**保持模式开启** |
| **连续操作** | 每次需要重新启用 | ✅ 支持连续插入/删除 |
| **使用场景** | 单次插入/删除 | 批量编辑，大量插入斜杠 |

---

## ✅ 实现细节

### 修改1：智能模式检测

**文件**：`script.js` 第595-601行

```javascript
if (state.lastSlash) {
    // 根据是否在快速标注模式，显示不同的提示信息
    if (quickAnnotationMode) {
        showToast('✓ 斜杠插入模式已启用（快速模式）\n• 点击位置插入 /\n• 再次点击已插入的 / 可删除\n• 支持连续插入', 'info');
    } else {
        showToast('✓ 斜杠插入模式已启用\n• 点击位置插入 /\n• 再次点击已插入的 / 可删除', 'info');
    }
}
```

**效果**：
- 启用斜杠插入模式时，自动检测是否在快速标注模式
- 显示不同的提示信息，明确告知用户当前模式的特性

---

### 修改2：删除斜杠功能

**文件**：`script.js` 第619-653行

```javascript
// 检查是否点击在已插入的斜杠上（删除功能）
const clickedNode = event.target.nodeType === Node.TEXT_NODE ? event.target : event.target.childNodes[0];
if (clickedNode && clickedNode.nodeType === Node.TEXT_NODE) {
    const text = clickedNode.textContent;
    const range = document.caretRangeFromPoint(event.clientX, event.clientY);

    if (range && range.startContainer === clickedNode) {
        const offset = range.startOffset;

        // 检查点击位置前后是否有斜杠字符
        if (text[offset] === '/' || text[offset - 1] === '/') {
            const slashIndex = text[offset] === '/' ? offset : offset - 1;

            // 删除斜杠字符
            const newText = text.substring(0, slashIndex) + text.substring(slashIndex + 1);
            clickedNode.textContent = newText;

            console.log('[斜杠删除] 已删除位置', slashIndex, '的斜杠字符');
            showToast('✓ 已删除斜杠', 'success');

            // 在快速标注模式下，删除后保持插入模式开启
            // 在普通模式下，删除后关闭插入模式
            if (!quickAnnotationMode) {
                state.lastSlash = false;
                dom.formatSlashToggle.classList.remove('active');
                dom.formatSlashToggle.setAttribute('aria-pressed', 'false');
                dom.readingArea.style.cursor = '';
                persistState();
            }
            return;
        }
    }
}
```

**效果**：
- 检测点击位置是否在斜杠字符上（包括点击斜杠前后的位置）
- 如果是，删除该斜杠字符
- 快速模式下删除后保持插入模式开启
- 普通模式下删除后自动关闭插入模式

---

### 修改3：连续插入支持

**文件**：`script.js` 第676-686行

```javascript
console.log('[斜杠插入] 在位置插入斜杠字符');

// 在快速标注模式下，插入后保持插入模式开启（支持连续插入）
// 在普通模式下，插入后自动关闭插入模式
if (!quickAnnotationMode) {
    state.lastSlash = false;
    dom.formatSlashToggle.classList.remove('active');
    dom.formatSlashToggle.setAttribute('aria-pressed', 'false');
    dom.readingArea.style.cursor = '';
} else {
    console.log('[斜杠插入] 快速标注模式：保持插入模式开启');
}
persistState();
```

**效果**：
- 快速模式下插入后不关闭插入模式
- 光标保持十字准星状态
- 按钮保持高亮状态
- 支持连续点击多次插入

---

## 🎯 使用指南

### 场景1：普通模式下的单次操作

```
1. 点击工具栏 "/" 按钮
   ↓
2. 提示："✓ 斜杠插入模式已启用
          • 点击位置插入 /
          • 再次点击已插入的 / 可删除"
   ↓
3. 在文本中点击一次 → 插入斜杠
   ↓
4. 自动退出插入模式（按钮取消高亮，光标恢复）
```

**适用场景**：只需要插入一个斜杠

---

### 场景2：快速标注模式下的连续操作

```
1. 先启用快速标注模式（点击"快速标注"按钮或按 Ctrl+Q）
   ↓
2. 点击工具栏 "/" 按钮
   ↓
3. 提示："✓ 斜杠插入模式已启用（快速模式）
          • 点击位置插入 /
          • 再次点击已插入的 / 可删除
          • 支持连续插入"
   ↓
4. 在文本中连续点击多次 → 每次都插入斜杠
   ↓
5. 插入模式保持开启（按钮保持高亮，光标保持十字准星）
   ↓
6. 点击已插入的斜杠 → 删除该斜杠
   ↓
7. 继续点击其他位置 → 继续插入
   ↓
8. 手动点击 "/" 按钮退出插入模式
```

**适用场景**：需要在多个位置插入斜杠，或需要反复调整斜杠位置

---

## 🧪 测试场景

### 测试1：普通模式下的单次插入

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|---------|------|
| 1 | 点击 "/" 按钮 | 按钮高亮 + 十字光标 + 普通提示 | ✅ |
| 2 | 点击文本位置 | 插入 "/" + 自动退出模式 | ✅ |
| 3 | 验证退出 | 按钮取消高亮 + 光标恢复 | ✅ |

### 测试2：普通模式下的删除

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|---------|------|
| 1 | 点击 "/" 按钮 | 按钮高亮 | ✅ |
| 2 | 点击已有斜杠 | 删除斜杠 + 显示"✓ 已删除斜杠" + 自动退出模式 | ✅ |

### 测试3：快速模式下的连续插入

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|---------|------|
| 1 | 启用快速标注模式 | 显示"✓ 快速标注模式已开启" | ✅ |
| 2 | 点击 "/" 按钮 | 按钮高亮 + 显示快速模式提示 | ✅ |
| 3 | 点击位置1 | 插入 "/" + 模式保持开启 | ✅ |
| 4 | 点击位置2 | 插入 "/" + 模式保持开启 | ✅ |
| 5 | 点击位置3 | 插入 "/" + 模式保持开启 | ✅ |
| 6 | 验证状态 | 按钮保持高亮 + 光标保持十字 | ✅ |

### 测试4：快速模式下的删除和继续插入

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|---------|------|
| 1 | 启用快速标注模式 + "/" 按钮 | 模式开启 | ✅ |
| 2 | 点击位置1插入 | 插入 "/" + 模式保持 | ✅ |
| 3 | 点击位置1的斜杠 | 删除 "/" + 模式保持开启 | ✅ |
| 4 | 点击位置2插入 | 插入 "/" + 模式保持 | ✅ |
| 5 | 手动点击 "/" 按钮 | 退出插入模式 | ✅ |

### 测试5：边界情况

| 场景 | 操作 | 预期结果 | 状态 |
|------|------|---------|------|
| 点击标注上 | 在高亮标注上点击 | 不插入斜杠，不删除 | ✅ |
| 点击区域外 | 在阅读区域外点击 | 不插入斜杠 | ✅ |
| 模式切换 | 插入模式开启时切换快速/普通模式 | 插入模式保持，提示更新 | ⚠️ 需要测试 |

---

## 💡 技术实现要点

### 1. 斜杠字符检测

```javascript
// 检查点击位置前后是否有斜杠
if (text[offset] === '/' || text[offset - 1] === '/') {
    const slashIndex = text[offset] === '/' ? offset : offset - 1;
    // 删除逻辑
}
```

**原理**：
- 点击位置可能在斜杠前面（offset指向斜杠）
- 也可能在斜杠后面（offset-1指向斜杠）
- 都需要检测并处理

### 2. 模式状态管理

```javascript
// 根据 quickAnnotationMode 决定是否关闭插入模式
if (!quickAnnotationMode) {
    // 普通模式：关闭插入模式
    state.lastSlash = false;
    dom.formatSlashToggle.classList.remove('active');
    dom.readingArea.style.cursor = '';
} else {
    // 快速模式：保持插入模式开启
    console.log('[斜杠插入] 快速标注模式：保持插入模式开启');
}
```

**原理**：
- 使用全局变量 `quickAnnotationMode` 检测当前模式
- 根据模式决定是否关闭插入模式
- 普通模式：一次性操作，自动关闭
- 快速模式：连续操作，手动关闭

### 3. 文本节点修改

```javascript
// 删除斜杠字符
const newText = text.substring(0, slashIndex) + text.substring(slashIndex + 1);
clickedNode.textContent = newText;
```

**原理**：
- 直接修改文本节点的 `textContent`
- 字符串拼接：删除指定索引的字符
- 保持其他内容不变

---

## ⚠️ 注意事项

### 1. 删除的精确性

**当前实现**：检测点击位置前后一个字符
**限制**：
- 需要比较精确地点击斜杠字符
- 在字体很小或触摸屏上可能不够准确

**未来优化建议**：
- 增加检测范围（前后2-3个字符）
- 添加视觉高亮，鼠标悬停时显示可删除的斜杠
- 使用特殊标记包裹插入的斜杠（如 `<span class="inserted-slash">/</span>`）

### 2. 与标注的交互

**当前行为**：不能在已有标注（`.highlight`）上插入或删除斜杠

**原因**：
- 保护标注结构完整性
- 避免破坏标注的 DOM 层次

**如需支持**：
- 需要在标注内部进行文本节点操作
- 需要更新标注记录的文本内容
- 复杂度较高，建议保持当前限制

### 3. 快速模式切换

**潜在问题**：如果在斜杠插入模式开启时，用户切换快速标注模式（Ctrl+Q），提示信息不会实时更新

**解决方案**：
```javascript
// 监听快速标注模式切换，更新斜杠插入模式的提示
function applyQuickFormat() {
    quickAnnotationMode = !quickAnnotationMode;
    // ... 现有逻辑 ...

    // 如果斜杠插入模式也是开启的，更新提示
    if (state.lastSlash && dom.formatSlashToggle) {
        if (quickAnnotationMode) {
            showToast('✓ 已切换到快速模式，支持连续插入斜杠', 'info');
        } else {
            showToast('✓ 已切换到普通模式，插入后将自动关闭', 'info');
        }
    }
}
```

---

## 📊 修改统计

| 文件 | 修改位置 | 修改类型 | 影响范围 |
|------|---------|---------|---------|
| `script.js` | 第595-601行 | 修改提示逻辑 | 斜杠按钮点击 |
| `script.js` | 第619-653行 | 新增删除功能 | 斜杠点击检测 |
| `script.js` | 第676-686行 | 修改关闭逻辑 | 插入后行为 |
| **总计** | **约70行** | **功能增强** | **低风险** |

---

## 🎓 用户使用技巧

### 技巧1：快速插入音标分隔符

```
场景：标注音标 /ˈhæp.i.nəs/

操作：
1. 启用快速标注模式
2. 点击 "/" 按钮
3. 依次点击：
   - "ˈhæp" 前 → 插入 /
   - "i" 后 → 插入 /
   - "nəs" 后 → 插入 /
4. 结果：/ˈhæp/i/nəs/
```

### 技巧2：快速标注语义分块

```
场景：长句分块 "I think that you are absolutely right about this"

操作：
1. 启用快速标注模式 + 斜杠插入模式
2. 在语义分块处插入斜杠：
   "I think / that you are / absolutely right / about this"
3. 如果位置不对，点击斜杠删除，重新插入
```

### 技巧3：快速删除多余斜杠

```
场景：清理文本中多余的斜杠

操作：
1. 启用快速标注模式
2. 点击 "/" 按钮
3. 依次点击文本中的多余斜杠，逐个删除
4. 无需重复启用插入模式
```

---

## 🚀 未来优化方向

### 优化1：视觉反馈增强

- [ ] 鼠标悬停在斜杠上时，显示删除图标或高亮效果
- [ ] 为插入的斜杠添加特殊样式（如不同颜色）
- [ ] 显示斜杠计数："已插入3个斜杠"

### 优化2：批量操作

- [ ] 支持选中多个斜杠批量删除
- [ ] 支持"撤销"功能（Ctrl+Z）
- [ ] 支持"清除所有斜杠"按钮

### 优化3：智能插入

- [ ] 自动检测音标模式，按音节插入斜杠
- [ ] 根据语义分析，建议插入位置
- [ ] 支持快捷键（如 Ctrl+/）

### 优化4：持久化

- [ ] 保存斜杠位置到标注数据
- [ ] 导出文本时包含斜杠
- [ ] 导入文本时识别斜杠

---

## 📝 总结

### 主要改进

✅ **连续插入**：快速模式下支持多次插入，无需重复启用
✅ **删除功能**：点击斜杠即可删除，支持反复调整
✅ **智能提示**：根据模式显示不同提示，用户体验清晰
✅ **模式兼容**：普通模式和快速模式行为分离，互不影响

### 适用场景

- ✅ 音标标注（需要频繁插入分隔符）
- ✅ 长句分块（语义单元划分）
- ✅ 词组分割（标注词组内部结构）
- ✅ 批量编辑（反复调整斜杠位置）

### 核心价值

从"单次操作"到"批量编辑"，大幅提升斜杠标注的效率和灵活性。

---

**更新完成！** 🎉

建议在 `reader.html` 中测试以下场景：
1. 普通模式下插入一个斜杠 → 自动关闭
2. 快速模式下连续插入多个斜杠 → 保持开启
3. 点击斜杠删除 → 成功删除
4. 切换模式后的行为差异
