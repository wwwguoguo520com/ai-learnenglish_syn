<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ­æ–‡è¾“å…¥ - è‹±è¯­é˜…è¯»æ ‡æ³¨å·¥å…·</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .input-page {
            max-width: 900px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .input-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .input-header h1 {
            margin: 0 0 8px;
            font-size: 28px;
            color: var(--text-dark);
        }

        .input-header p {
            margin: 0;
            color: var(--text-muted);
            font-size: 15px;
        }

        .input-container {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 18px;
            box-shadow: var(--shadow);
            padding: 24px;
        }

        .input-section {
            margin-bottom: 24px;
        }

        .input-section h2 {
            margin: 0 0 16px;
            font-size: 18px;
            font-weight: 600;
        }

        #sourceText {
            width: 100%;
            min-height: 300px;
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 16px;
            font-size: 15px;
            line-height: 1.6;
            font-family: inherit;
            resize: vertical;
        }

        .input-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-primary-large {
            flex: 1;
            min-width: 200px;
            padding: 14px 28px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(47, 84, 235, 0.3);
        }

        .btn-primary-large:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(47, 84, 235, 0.4);
        }

        .document-section {
            margin-top: 32px;
        }

        .document-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .document-card {
            background: #f7f9ff;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .document-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(47, 84, 235, 0.15);
        }

        .document-card.active {
            border-color: var(--primary);
            background: rgba(47, 84, 235, 0.08);
        }

        .document-card-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
            font-size: 15px;
        }

        .document-card-preview {
            color: var(--text-muted);
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .document-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-muted);
        }

        .document-card-actions {
            display: flex;
            gap: 8px;
        }

        .document-card-actions button {
            padding: 4px 10px;
            font-size: 12px;
            background: rgba(47, 84, 235, 0.1);
            color: var(--primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .document-card-actions button:hover {
            background: rgba(47, 84, 235, 0.2);
        }

        .document-card-actions button.delete {
            background: rgba(248, 113, 113, 0.1);
            color: #dc2626;
        }

        .document-card-actions button.delete:hover {
            background: rgba(248, 113, 113, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="input-page">
        <header class="input-header">
            <h1>ğŸ“ è‹±è¯­çŸ­æ–‡è¾“å…¥</h1>
            <p>è¾“å…¥æˆ–ç²˜è´´è‹±æ–‡çŸ­æ–‡ï¼Œå¼€å§‹æ‚¨çš„å­¦ä¹ ä¹‹æ—…</p>
        </header>

        <div class="input-container">
            <div class="input-section">
                <h2>è¾“å…¥çŸ­æ–‡</h2>
                <textarea id="sourceText" placeholder="åœ¨æ­¤ç²˜è´´æˆ–è¾“å…¥è‹±æ–‡çŸ­æ–‡...&#10;&#10;æ”¯æŒ Markdown æ ¼å¼è‡ªåŠ¨è½¬æ¢" spellcheck="false"></textarea>
            </div>

            <div class="input-actions">
                <button type="button" id="loadTextBtn" class="btn-primary-large">ğŸ’¾ ä¿å­˜å¹¶è¿›å…¥é˜…è¯»</button>
                <button type="button" id="importMarkdownBtn" class="ghost-btn">ğŸ“„ å¯¼å…¥ Markdown</button>
                <input id="importMarkdownInput" type="file" accept=".md,.markdown,text/markdown" class="visually-hidden">
                <button type="button" id="clearInputBtn" class="ghost-btn">ğŸ—‘ï¸ æ¸…ç©º</button>
            </div>
        </div>

        <div class="document-section">
            <h2>å·²ä¿å­˜çš„çŸ­æ–‡</h2>
            <div id="documentGrid" class="document-grid"></div>
            <div id="emptyState" class="empty-state hidden">
                <div class="empty-state-icon">ğŸ“š</div>
                <p>æš‚æ— ä¿å­˜çš„çŸ­æ–‡</p>
                <p style="font-size: 13px;">è¾“å…¥çŸ­æ–‡åç‚¹å‡»"ä¿å­˜å¹¶è¿›å…¥é˜…è¯»"å¼€å§‹</p>
            </div>
        </div>
    </div>

    <script>
        // ä» localStorage åŠ è½½æ•°æ®
        const STORAGE_KEY = 'reading-annotator:data:v1';
        let editingDocId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ–‡æ¡£ID

        function loadState() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) return { documents: [], activeDocumentId: null };
                const parsed = JSON.parse(stored);
                // ç¡®ä¿ documents æ•°ç»„å­˜åœ¨
                if (!parsed.documents) {
                    parsed.documents = [];
                }
                return parsed;
            } catch {
                return { documents: [], activeDocumentId: null };
            }
        }

        function saveState(state) {
            try {
                // ä¿æŒç°æœ‰æ•°æ®ï¼Œåªæ›´æ–° documents å’Œ activeDocumentId
                const existing = localStorage.getItem(STORAGE_KEY);
                const fullState = existing ? JSON.parse(existing) : {};
                fullState.documents = state.documents;
                fullState.activeDocumentId = state.activeDocumentId;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(fullState));
            } catch (e) {
                console.error('ä¿å­˜å¤±è´¥:', e);
            }
        }

        function generateId() {
            return `doc-${Math.random().toString(16).slice(2)}-${Date.now().toString(36)}`;
        }

        function renderDocuments() {
            const state = loadState();
            const grid = document.getElementById('documentGrid');
            const emptyState = document.getElementById('emptyState');

            if (!state.documents || state.documents.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            grid.innerHTML = '';

            state.documents.forEach(doc => {
                const card = document.createElement('div');
                card.className = 'document-card';
                if (doc.id === state.activeDocumentId) {
                    card.className += ' active';
                }

                const preview = doc.content.substring(0, 100);
                const date = new Date(doc.createdAt).toLocaleDateString('zh-CN');

                card.innerHTML = `
                    <div class="document-card-title">${escapeHtml(doc.title || 'æœªå‘½åæ–‡æ¡£')}</div>
                    <div class="document-card-preview">${escapeHtml(preview)}...</div>
                    <div class="document-card-meta">
                        <span>${date}</span>
                        <div class="document-card-actions">
                            <button onclick="openDocument('${doc.id}')">æ‰“å¼€</button>
                            <button onclick="editDocument('${doc.id}', event)">ç¼–è¾‘</button>
                            <button class="delete" onclick="deleteDocument('${doc.id}', event)">åˆ é™¤</button>
                        </div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openDocument(docId) {
            const state = loadState();
            state.activeDocumentId = docId;
            saveState(state);
            window.location.href = `reader.html?doc=${docId}`;
        }

        function editDocument(docId, event) {
            event.stopPropagation();
            const state = loadState();
            const doc = state.documents.find(d => d.id === docId);
            if (!doc) return;

            // åŠ è½½æ–‡æ¡£å†…å®¹åˆ°æ–‡æœ¬æ¡†
            document.getElementById('sourceText').value = doc.content;
            editingDocId = docId;

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const btn = document.getElementById('loadTextBtn');
            btn.textContent = 'ğŸ’¾ æ›´æ–°å¹¶è¿›å…¥é˜…è¯»';

            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteDocument(docId, event) {
            event.stopPropagation();
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡çŸ­æ–‡å—ï¼Ÿ')) return;

            const state = loadState();
            state.documents = state.documents.filter(d => d.id !== docId);
            if (state.activeDocumentId === docId) {
                state.activeDocumentId = null;
            }
            saveState(state);
            renderDocuments();
        }

        function saveAndOpen() {
            const content = document.getElementById('sourceText').value.trim();
            if (!content) {
                alert('è¯·å…ˆè¾“å…¥çŸ­æ–‡å†…å®¹');
                return;
            }

            const state = loadState();

            if (editingDocId) {
                // æ›´æ–°ç°æœ‰æ–‡æ¡£
                const doc = state.documents.find(d => d.id === editingDocId);
                if (doc) {
                    doc.content = content;
                    doc.updatedAt = new Date().toISOString();
                    const firstLine = content.split('\n')[0].substring(0, 50);
                    doc.title = firstLine || 'æœªå‘½åæ–‡æ¡£';

                    state.activeDocumentId = editingDocId;
                    saveState(state);
                    window.location.href = `reader.html?doc=${editingDocId}`;
                }
            } else {
                // åˆ›å»ºæ–°æ–‡æ¡£
                const docId = generateId();
                const firstLine = content.split('\n')[0].substring(0, 50);
                const title = firstLine || 'æœªå‘½åæ–‡æ¡£';

                const now = new Date().toISOString();
                const newDoc = {
                    id: docId,
                    title: title,
                    content: content,
                    createdAt: now,
                    updatedAt: now,
                    annotations: []
                };

                if (!state.documents) {
                    state.documents = [];
                }
                state.documents.unshift(newDoc);
                state.activeDocumentId = docId;

                saveState(state);
                window.location.href = `reader.html?doc=${docId}`;
            }
        }

        function clearInput() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºè¾“å…¥å†…å®¹å—ï¼Ÿ')) {
                document.getElementById('sourceText').value = '';
                editingDocId = null;
                document.getElementById('loadTextBtn').textContent = 'ğŸ’¾ ä¿å­˜å¹¶è¿›å…¥é˜…è¯»';
            }
        }

        function importMarkdown() {
            document.getElementById('importMarkdownInput').click();
        }

        function handleMarkdownImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const plainText = convertMarkdownToPlain(content);
                document.getElementById('sourceText').value = plainText;
            };
            reader.readAsText(file);
        }

        function convertMarkdownToPlain(markdown) {
            return markdown
                .replace(/^#{1,6}\s+/gm, '')
                .replace(/\*\*(.+?)\*\*/g, '$1')
                .replace(/__(.+?)__/g, '$1')
                .replace(/\*(.+?)\*/g, '$1')
                .replace(/_(.+?)_/g, '$1')
                .replace(/\[(.+?)\]\(.+?\)/g, '$1')
                .replace(/!\[.*?\]\(.+?\)/g, '')
                .replace(/^```[\s\S]*?^```/gm, '')
                .replace(/`(.+?)`/g, '$1')
                .replace(/^>\s+/gm, '')
                .replace(/^[\*\-\+]\s+/gm, '')
                .replace(/^\d+\.\s+/gm, '');
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('loadTextBtn').addEventListener('click', saveAndOpen);
        document.getElementById('clearInputBtn').addEventListener('click', clearInput);
        document.getElementById('importMarkdownBtn').addEventListener('click', importMarkdown);
        document.getElementById('importMarkdownInput').addEventListener('change', handleMarkdownImport);

        // åˆå§‹åŒ–
        renderDocuments();
    </script>
</body>
</html>
